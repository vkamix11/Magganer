<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title>Połącz się</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body {
  margin: 0;
  background: #0f0f0f;
  color: #fff;
  font-family: Arial, sans-serif;
}

/* EKRANY */
#login, #app, #call {
  display: none;
  height: 100vh;
}

/* LOGIN */
#login {
  display: flex;
  justify-content: center;
  align-items: center;
}

/* APP */
#top {
  padding: 10px;
  background: #181818;
}
input, button {
  padding: 10px;
  margin: 5px;
  background: #222;
  color: #fff;
  border: none;
}
.user {
  padding: 10px;
  cursor: pointer;
}
.user:hover {
  background: #222;
}

/* CALL */
#call {
  position: fixed;
  inset: 0;
  background: #000;
  flex-direction: column;
  align-items: center;
}
video {
  width: 200px;
  margin: 5px;
  background: #000;
}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="login">
  <div>
    <h2>Wpisz swój nick</h2>
    <input id="nickInput" placeholder="Nick">
    <button onclick="saveNick()">Wejdź</button>
  </div>
</div>

<!-- APP -->
<div id="app">
  <div id="top">
    <input id="search" placeholder="Szukaj użytkownika" oninput="renderUsers()">
  </div>
  <div id="users"></div>
</div>

<!-- CALL -->
<div id="call">
  <h2 id="callTitle"></h2>
  <video id="remoteVideo" autoplay></video>
  <video id="localVideo" autoplay muted></video>
  <button onclick="hangup()">❌ Rozłącz</button>
</div>

<script>
/* FIREBASE */
firebase.initializeApp({
  apiKey: "AIzaSyD8maHB4twE8dSWnoLOgsd8FcQFMbqIUzY",
  authDomain: "polacz-sie.firebaseapp.com",
  projectId: "polacz-sie"
});
const db = firebase.firestore();

/* GLOBAL */
let nick = localStorage.getItem("nick");
let pc, localStream;
let lastUsers = null;

/* START */
window.onload = () => {
  if (!nick) {
    login.style.display = "flex";
  } else {
    startApp();
  }
};

function saveNick() {
  nick = nickInput.value.trim();
  if (!nick) return;
  localStorage.setItem("nick", nick);
  startApp();
}

/* APP */
function startApp() {
  login.style.display = "none";
  app.style.display = "block";

  db.collection("users").doc(nick).set({ online: true });

  db.collection("users").onSnapshot(snap => {
    lastUsers = snap;
    renderUsers();
  });

  listenForCalls();
}

/* USERS */
function renderUsers() {
  if (!lastUsers) return;
  users.innerHTML = "";
  const filter = search.value.toLowerCase();

  lastUsers.forEach(doc => {
    if (doc.id !== nick && doc.id.toLowerCase().includes(filter)) {
      users.innerHTML += `
        <div class="user" onclick="callUser('${doc.id}')">${doc.id}</div>
      `;
    }
  });
}

/* CALL */
async function callUser(target) {
  showCall(target);

  pc = new RTCPeerConnection({
    iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
  });

  localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
  localStream.getTracks().forEach(t => pc.addTrack(t, localStream));

  pc.ontrack = e => remoteVideo.srcObject = e.streams[0];

  const callDoc = db.collection("calls").doc();

  pc.onicecandidate = e => {
    if (e.candidate)
      callDoc.collection("caller").add(e.candidate.toJSON());
  };

  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);

  await callDoc.set({ from: nick, to: target, offer });

  callDoc.onSnapshot(d => {
    if (d.data()?.answer)
      pc.setRemoteDescription(d.data().answer);
  });

  callDoc.collection("callee").onSnapshot(s => {
    s.docChanges().forEach(c =>
      pc.addIceCandidate(new RTCIceCandidate(c.doc.data()))
    );
  });
}

function listenForCalls() {
  db.collection("calls").where("to", "==", nick)
    .onSnapshot(snap => {
      snap.docChanges().forEach(async c => {
        const data = c.doc.data();
        showCall(data.from);

        pc = new RTCPeerConnection({
          iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
        });

        localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        localStream.getTracks().forEach(t => pc.addTrack(t, localStream));

        pc.ontrack = e => remoteVideo.srcObject = e.streams[0];

        pc.onicecandidate = e => {
          if (e.candidate)
            c.doc.ref.collection("callee").add(e.candidate.toJSON());
        };

        await pc.setRemoteDescription(data.offer);
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        await c.doc.ref.update({ answer });

        c.doc.ref.collection("caller").onSnapshot(s =>
          s.docChanges().forEach(i =>
            pc.addIceCandidate(new RTCIceCandidate(i.doc.data()))
          )
        );
      });
    });
}

function showCall(other) {
  app.style.display = "none";
  call.style.display = "flex";
  callTitle.innerText = "Rozmowa z " + other;
}

function hangup() {
  if (pc) pc.close();
  location.reload();
}
</script>
</body>
</html>
